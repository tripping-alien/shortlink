<!DOCTYPE html>
<html lang="{{ locale }}" dir="{{ 'rtl' if locale in ['ar', 'he'] else 'ltr' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ _("app_title") }}</title>
    <meta name="description" content="{{ _('meta_description_main') }}">
    <meta name="keywords" content="{{ _('meta_keywords_main') }}">
    
    <link rel="canonical" href="https://shortlinks.art/" />
    <meta name="robots" content="index, follow">
    <meta name="google-site-verification" content="YOUR_GOOGLE_CODE_HERE" />
    <meta name="msvalidate.01" content="YOUR_BING_CODE_HERE" />
    <meta name="yandex-verification" content="YOUR_YANDEX_CODE_HERE" />
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://shortlinks.art/">
    
    <meta property="og:title" content="{{ _('app_title') }}">
    <meta property="og:description" content="{{ _('meta_description_og') }}">
    <meta property="og:image" content="https://shortlinks.art/assets/social-preview.jpg"> 
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://shortlinks.art/">
    <meta property="twitter:title" content="{{ _('app_title') }}">
    <meta property="twitter:description" content="{{ _('meta_description_og') }}">
    
    <meta property="twitter:image" content="https://shortlinks.art/assets/social-preview.jpg">
    
    {% for tag in hreflang_tags %}
    <link rel="{{ tag.rel }}" hreflang="{{ tag.hreflang }}" href="{{ tag.href }}">
    {% endfor %}

    {{ ADSENSE_SCRIPT|safe }} 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>
<body>
    <div class="card">
      <a href="{{ url_for('localized:dashboard', locale=locale) }}" class="header-link">{{ _("my_links_button") }} →</a>
      <h1>Shortlinks<span>.art</span></h1>
      <p class="tagline">{{ _("tagline") }}</p>
      
      <input type="url" id="longUrl" placeholder="{{ _('long_url_placeholder') }}">
      <select id="ttl">
        <option value="1h">{{ _("ttl_1h") }}</option>
        <option value="24h" selected>{{ _("ttl_24h") }}</option>
        <option value="1w">{{ _("ttl_1w") }}</option>
        <option value="never">{{ _("ttl_never") }}</option>
      </select>
      <a href="#" class="advanced-options-toggle" id="advanced-toggle">{{ _("advanced_options_button") }} <span>+</span></a>
      <div id="advanced-options">
          <input type="text" id="customCode" placeholder="{{ _('custom_code_label') }}">
          <input type="text" id="utmTags" placeholder="{{ _('utm_tags_placeholder') }}">
      </div>
      <div id="error-msg"></div>
      <button id="shortenBtn">
          <span class="btn-text">{{ _("create_button") }}</span>
          <div class="spinner"></div>
      </button>
      
      <div id="result">
        <div class="result-item">
          <span>{{ _("result_short_link") }}</span>
          <div>
            <a href="#" id="shortUrlLink" target="_blank" rel="noopener noreferrer"></a>
            <button class="copy-btn" id="copyBtn">{{ _("copy_button") }}</button>
          </div>
        </div>
        <div class="result-item">
            <span>{{ _("result_stats_page") }}</span>
            <a href="#" id="statsUrlLink" target="_blank" rel="noopener noreferrer">{{ _("result_view_clicks") }}</a>
        </div>
        <div id="qr-code-box">
            <img id="qrCode" src="" alt="QR Code">
        </div>
        <div id="delete-link-box">
            <p><strong>{{ _("result_save_link_strong") }}</strong> {{ _("result_save_link_text") }}</p>
            <a href="#" id="deleteUrlLink" target="_blank"></a>
        </div>
      </div>
    </div>

    <footer class="footer">
        <span>© {{ current_year }} Shortlinks.art</span>
        <a href="{{ url_for('localized:index', locale=locale) }}">{{ _("nav_home") }}</a>
        <a href="{{ url_for('localized:about', locale=locale) }}">{{ _("nav_about") }}</a>

        <div class="language-switcher">
            {% for tag in hreflang_tags %}
              {% if tag.hreflang != 'x-default' %}
                <a href="{{ tag.href }}" 
                   class="lang-btn {{ 'active' if tag.hreflang == locale else '' }}" 
                   data-lang="{{ tag.hreflang }}">
                   {{ tag.hreflang.upper() }}
                </a>
              {% endif %}
            {% endfor %}
        </div>
    </footer>

    <script>
    // Constants
    const shortenBtn = document.getElementById("shortenBtn");
    const resultDiv = document.getElementById("result");
    const errorDiv = document.getElementById("error-msg");
    const shortUrlLink = document.getElementById("shortUrlLink");
    const copyBtn = document.getElementById("copyBtn");
    const statsUrlLink = document.getElementById("statsUrlLink");
    const qrCodeImg = document.getElementById("qrCode");
    const deleteUrlLink = document.getElementById("deleteUrlLink");
    const advancedToggle = document.getElementById("advanced-toggle");
    const advancedOptionsDiv = document.getElementById("advanced-options");

    // Translated strings
    const TEXT_ENTER_URL = "{{ _('js_enter_url') }}";
    const TEXT_ERROR = "{{ _('js_error_creating') }}";
    const TEXT_ERROR_SERVER = "{{ _('js_error_server') }}";
    const TEXT_SHORTEN = "{{ _('create_button') }}";
    const TEXT_COPIED = "{{ _('js_copied') }}";
    const TEXT_COPY = "{{ _('copy_button') }}";
    const TEXT_FAILED = "{{ _('js_copy_failed') }}";

    // Owner ID logic
    let ownerId = null;
    function getOrSetOwnerId() {
        const idKey = 'shortlinks_owner_id';
        let storedId = localStorage.getItem(idKey);
        if (!storedId) {
            storedId = crypto.randomUUID();
            localStorage.setItem(idKey, storedId);
        }
        return storedId;
    }
    ownerId = getOrSetOwnerId();

    // Advanced options toggle
    advancedToggle.addEventListener("click", (e) => {
        e.preventDefault();
        const isShown = advancedOptionsDiv.classList.toggle("show");
        advancedToggle.querySelector("span").textContent = isShown ? "−" : "+";
    });

    // Shorten button logic
    shortenBtn.addEventListener("click", async () => {
        const longUrl = document.getElementById("longUrl").value.trim();
        const ttl = document.getElementById("ttl").value;
        const customCode = document.getElementById("customCode").value.trim() || undefined;
        const utmTags = document.getElementById("utmTags").value.trim() || undefined;
        errorDiv.style.display = "none";
        errorDiv.textContent = "";
        resultDiv.classList.remove("show");
        if (!longUrl) {
            errorDiv.textContent = TEXT_ENTER_URL;
            errorDiv.style.display = "block";
            return;
        }
        shortenBtn.disabled = true;
        shortenBtn.classList.add("loading");
        try {
            // API routes are not localized, they live at the root
            const res = await fetch("/api/v1/links", {
                method:"POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    long_url: longUrl, 
                    ttl: ttl, 
                    custom_code: customCode, 
                    utm_tags: utmTags,
                    owner_id: ownerId
                })
            });
            const data = await res.json();
            if (res.ok) {
                // The API now returns fully localized URLs
                shortUrlLink.href = data.short_url; 
                shortUrlLink.textContent = data.short_url.replace(/^https?:\/\//, '');
                statsUrlLink.href = data.stats_url;
                deleteUrlLink.href = data.delete_url;
                deleteUrlLink.textContent = data.delete_url.replace(/^https?:\/\//, '');
                qrCodeImg.src = data.qr_code_data;
                resultDiv.classList.add("show");
            } else {
                errorDiv.textContent = data.detail || TEXT_ERROR;
                errorDiv.style.display = "block";
            }
        } catch(err) {
            console.error(err);
            errorDiv.textContent = TEXT_ERROR_SERVER;
            errorDiv.style.display = "block";
        } finally {
            shortenBtn.disabled = false;
            shortenBtn.classList.remove("loading");
        }
    });

    // Copy button logic
    copyBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(shortUrlLink.href)
            .then(() => {
                copyBtn.textContent = TEXT_COPIED;
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = TEXT_COPY;
                    copyBtn.disabled = false;
                }, 2000);
            })
            .catch(() => {
                copyBtn.textContent = TEXT_FAILED;
                copyBtn.disabled = true;
                 setTimeout(() => {
                    copyBtn.textContent = TEXT_COPY;
                    copyBtn.disabled = false;
                }, 2000);
            });
    });

    /* DELETED: The JavaScript language switcher is no longer needed
      as the buttons are now simple <a> links.
    */
    </script>
</body>
</html>
