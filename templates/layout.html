<!DOCTYPE html>
<html lang="{{ locale }}" dir="{{ 'rtl' if locale in RTL_LOCALES else 'ltr' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ _("app_title") }}</title>
    <meta name="description" content="{{ _('meta_description_main') }}">
    <meta name="keywords" content="{{ _('meta_keywords_main') }}">
    
    <link rel="canonical" href="https://shortlinks.art/" />
    <meta name="robots" content="index, follow">
    <meta name="google-site-verification" content="YOUR_GOOGLE_CODE_HERE" />
    <meta name="msvalidate.01" content="YOUR_BING_CODE_HERE" />
    <meta name="yandex-verification" content="YOUR_YANDEX_CODE_HERE" />
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://shortlinks.art/">
    <meta property="og:title" content="{{ _('app_title') }}">
    <meta property="og:description" content="{{ _('meta_description_og') }}">
    <meta property="og:image" content="https://shortlinks.art/assets/social-preview.jpg"> 
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://shortlinks.art/">
    <meta property="twitter:title" content="{{ _('app_title') }}">
    <meta property="twitter:description" content="{{ _('meta_description_og') }}">
    <meta property="twitter:image" content="https://shortlinks.art/assets/social-preview.jpg">
    
    {% for tag in hreflang_tags %}
    <link rel="{{ tag.rel }}" hreflang="{{ tag.hreflang }}" href="{{ tag.href }}">
    {% endfor %}

    {{ ADSENSE_SCRIPT|safe }} 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
    
    <style>
      /* Accessibility: class for visually hidden labels */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }
      /* Style for the new flag icons */
      .lang-flag {
        width: 24px; /* Set your desired flag size */
        height: auto;
        border-radius: 3px;
        vertical-align: middle;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .lang-btn.active .lang-flag {
        border: 2px solid #fff; /* Highlight active language */
      }
      /* Loading State CSS */
      #shortenBtn.loading .btn-text { display: none; }
      #shortenBtn .spinner { display: none; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: auto; }
      #shortenBtn.loading .spinner { display: block; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #result { display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
      #result.show { display: block; }
      #error-msg { display: none; color: #dc3545; margin-top: 10px; padding: 10px; border: 1px solid #dc3545; background: #f8d7da; border-radius: 4px; }
      #advanced-options { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
      #advanced-options.show { display: block; }
      .result-item div { display: flex; align-items: center; gap: 10px; }
      .result-item a { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      #qr-code-box { text-align: center; margin-top: 15px; }
      #qrCode { width: 150px; height: 150px; }
    </style>
</head>
<body>
    <main class="card">
      <a href="{{ url_for('localized:dashboard_page', locale=locale) }}" class="header-link">
        {{ _("my_links_button") }} 
        <span aria-hidden="true">→</span>
      </a>
      <h1>Shortlinks<span>.art</span></h1>
      <p class="tagline">{{ _("tagline") }}</p>
      
      <label for="longUrl" class="sr-only">{{ _('long_url_placeholder') }}</label>
      <input type="url" id="longUrl" placeholder="{{ _('long_url_placeholder') }}" required>
      
      <label for="ttl" class="sr-only">{{ _("ttl_label") }}</label>
      <select id="ttl">
        <option value="1h">{{ _("ttl_1h") }}</option>
        <option value="24h" selected>{{ _("ttl_24h") }}</option>
        <option value="1w">{{ _("ttl_1w") }}</option>
        <option value="never">{{ _("ttl_never") }}</option>
      </select>

      <button class="advanced-options-toggle" id="advanced-toggle" aria-expanded="false" aria-controls="advanced-options">
          {{ _("advanced_options_button") }} 
          <span>+</span>
      </button>

      <div id="advanced-options">
          <label for="customCode" class="sr-only">{{ _('custom_code_label') }}</label>
          <input type="text" id="customCode" placeholder="{{ _('custom_code_label') }}">
          
          <label for="utmTags" class="sr-only">{{ _('utm_tags_placeholder') }}</label>
          <input type="text" id="utmTags" placeholder="{{ _('utm_tags_placeholder') }}">
      </div>
      
      <div id="error-msg" role="alert"></div>
      
      <button id="shortenBtn">
          <span class="btn-text">{{ _("create_button") }}</span>
          <div class="spinner"></div>
      </button>
      
      <div id="result" role="status" aria-live="polite">
        <div class="result-item">
          <span id="short-link-label">{{ _("result_short_link") }}</span>
          <div>
            <a href="#" id="shortUrlLink" target="_blank" rel="noopener noreferrer" aria-labelledby="short-link-label"></a>
            <button class="copy-btn" id="copyBtn">{{ _("copy_button") }}</button>
          </div>
        </div>
        <div class="result-item">
            <span id="stats-page-label">{{ _("result_stats_page") }}</span>
            <a href="#" id="statsUrlLink" target="_blank" rel="noopener noreferrer" aria-labelledby="stats-page-label">{{ _("result_view_clicks") }}</a>
        </div>
        <div id="qr-code-box">
            <img id="qrCode" src="" alt="QR Code for short link">
        </div>
        <div id="delete-link-box">
            <p><strong>{{ _("result_save_link_strong") }}</strong> {{ _("result_save_link_text") }}</p>
            <a href="#" id="deleteUrlLink" target="_blank"></a>
        </div>
      </div>
    </main>

    <footer class="footer">
        <span>© {{ current_year }} Shortlinks.art</span>
        <a href="{{ url_for('localized:home_page', locale=locale) }}">{{ _("nav_home") }}</a>
        <a href="{{ url_for('localized:about_page', locale=locale) }}">{{ _("nav_about") }}</a>

        <nav class="language-switcher" aria-label="{{ _('language_switcher_label') }}">
            {% for tag in hreflang_tags %}
              {% if tag.hreflang != 'x-default' %}
                <a href="{{ tag.href }}" 
                   class="lang-btn {{ 'active' if tag.hreflang == locale else '' }}" 
                   data-lang="{{ tag.hreflang }}">
                   <img src="{{ url_for('static', path='flags/' + tag.hreflang + '.svg') }}" 
                        alt="{{ _('lang_name_' ~ tag.hreflang) }}"
                        class="lang-flag">
                </a>
              {% endif %}
            {% endfor %}
        </nav>
    </footer>

    <script>
    // --- 1. JINJA2 TRANSLATION INJECTION (Fixing the JS global variables) ---
    // These constants make sure the JavaScript code can access the translated strings.
    const TEXT_ENTER_URL = "{{ _('js_enter_url') }}";
    const TEXT_ERROR = "{{ _('js_error_creating') }}";
    const TEXT_ERROR_SERVER = "{{ _('js_error_server') }}";
    const TEXT_SHORTEN = "{{ _('create_button') }}";
    const TEXT_COPIED = "{{ _('js_copied') }}";
    const TEXT_COPY = "{{ _('copy_button') }}";
    const TEXT_FAILED = "{{ _('js_copy_failed') }}";

    // --- 2. MAIN JAVASCRIPT LOGIC ---
    const shortenBtn = document.getElementById("shortenBtn");
    const resultDiv = document.getElementById("result");
    const errorDiv = document.getElementById("error-msg");
    const shortUrlLink = document.getElementById("shortUrlLink");
    const copyBtn = document.getElementById("copyBtn");
    const statsUrlLink = document.getElementById("statsUrlLink");
    const qrCodeImg = document.getElementById("qrCode");
    const deleteUrlLink = document.getElementById("deleteUrlLink");
    const advancedToggle = document.getElementById("advanced-toggle");
    const advancedOptionsDiv = document.getElementById("advanced-options");

    let ownerId = null;

    /**
     * Retrieves or creates a unique owner ID for local link management.
     */
    function getOrSetOwnerId() {
        const idKey = 'shortlinks_owner_id';
        let storedId = localStorage.getItem(idKey);
        if (!storedId) {
            // Use a secure random ID generator
            storedId = crypto.randomUUID(); 
            localStorage.setItem(idKey, storedId);
        }
        return storedId;
    }

    ownerId = getOrSetOwnerId();

    /**
     * Toggles the visibility of the advanced options panel.
     */
    advancedToggle.addEventListener("click", (e) => {
        const isShown = advancedOptionsDiv.classList.toggle("show");
        advancedToggle.setAttribute("aria-expanded", isShown); 
        // Update the visual indicator (+/-)
        advancedToggle.querySelector("span").textContent = isShown ? "−" : "+"; 
    });

    /**
     * Handles the short link creation process.
     */
    shortenBtn.addEventListener("click", async () => {
        const longUrl = document.getElementById("longUrl").value.trim();
        const ttl = document.getElementById("ttl").value;
        const customCode = document.getElementById("customCode").value.trim() || undefined;
        const utmTags = document.getElementById("utmTags").value.trim() || undefined;

        // Reset UI state
        errorDiv.style.display = "none";
        errorDiv.textContent = "";
        resultDiv.classList.remove("show");

        if (!longUrl) {
            errorDiv.textContent = TEXT_ENTER_URL;
            errorDiv.style.display = "block";
            return;
        }

        // Set loading state
        shortenBtn.disabled = true;
        shortenBtn.classList.add("loading");

        try {
            const res = await fetch("/api/v1/links", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    long_url: longUrl, 
                    ttl: ttl, 
                    custom_code: customCode, 
                    utm_tags: utmTags,
                    owner_id: ownerId
                })
            });

            const data = await res.json();

            if (res.ok) {
                // Update result links and QR code
                shortUrlLink.href = data.short_url; 
                shortUrlLink.textContent = data.short_url.replace(/^https?:\/\//, '');
                statsUrlLink.href = data.stats_url;
                deleteUrlLink.href = data.delete_url;
                deleteUrlLink.textContent = data.delete_url.replace(/^https?:\/\//, '');
                qrCodeImg.src = data.qr_code_data;
                
                // Show result section
                resultDiv.classList.add("show");
            } else {
                // Display specific API error
                errorDiv.textContent = data.detail || TEXT_ERROR;
                errorDiv.style.display = "block";
            }
        } catch(err) {
            console.error(err);
            errorDiv.textContent = TEXT_ERROR_SERVER;
            errorDiv.style.display = "block";
        } finally {
            // Reset loading state
            shortenBtn.disabled = false;
            shortenBtn.classList.remove("loading");
        }
    });

    /**
     * Handles copying the short link to the clipboard.
     */
    copyBtn.addEventListener("click", () => {
        // Use shortUrlLink.href (the full URL) for copying
        navigator.clipboard.writeText(shortUrlLink.href)
            .then(() => {
                copyBtn.textContent = TEXT_COPIED;
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = TEXT_COPY;
                    copyBtn.disabled = false;
                }, 2000);
            })
            .catch(() => {
                // Fallback for clipboard failure
                copyBtn.textContent = TEXT_FAILED;
                copyBtn.disabled = true;
                 setTimeout(() => {
                    copyBtn.textContent = TEXT_COPY;
                    copyBtn.disabled = false;
                }, 2000);
            });
    });

    </script>
</body>
</html>
